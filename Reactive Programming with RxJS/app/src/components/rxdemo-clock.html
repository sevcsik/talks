<link rel="import" href="../../node_modules/@polymer/polymer/polymer-element.html">
<link rel="import" href="../../node_modules/@polymer/polymer/lib/elements/dom-if.html">


<dom-module id="rxdemo-clock">
	<template>
		<style>
			:host {
				display: inline-block;
				float: right;
				font-size: 10px;
				text-align: right;
			}

			:host(.active) {
				display: block;
				float: none;
				font-size: 32px;
				text-align: center;
			}
		</style>
		<div>
			<template is="dom-if" if="[[showTask]]">
				<p>[[activeTask.name]]</p>
			</template>
			<a href="#clock">{{hours}}:{{minutes}}:{{seconds}}</a>
		</div>
	</template>

	<script type="module">
		import { time$ } from 'src/services/time.js'
		import { activeScreen$
		       , activeTask$
		       } from 'src/services/state.js'

		import { Observable } from 'node_modules/rxjs/bundles/Rx.js'

		const formatTime$ = m => {
			const MODULI = [ 60, 60, 60, 24 ]
			return time$.map(t => Math.floor(t / Math.pow(MODULI[m], m)) % MODULI[m + 1])
		}

		/**
		 * @customElement
		 * @polymer
		 */
		class RxdemoClock extends Polymer.Element {
			static get is() { return 'rxdemo-clock' }

			constructor() {
				super();

				this.hours = this.minutes = this.seconds = null
				this.activeTask = null
				this.showTask = null

				this.classList.add('in-header')

				const isActive$ = activeScreen$
					.map(screen => screen === 'clock')
				
				isActive$.subscribe(active => { 
					this.active = active
					if (active) this.classList.add('active')
					else this.classList.remove('active')
				})

				activeTask$
					.subscribe(t => this.activeTask = t)

				Observable.combineLatest(isActive$, activeTask$)
					.do(console.log)
					.map(([isActive, activeTask]) => isActive && activeTask)
					.subscribe(showTask => this.showTask = showTask)

				formatTime$(0).subscribe(t => this.seconds = t)
				formatTime$(1).subscribe(t => this.minutes = t)
				formatTime$(2).subscribe(t => this.hours = t)
			}
		}

		window.customElements.define(RxdemoClock.is, RxdemoClock)
	</script>
</dom-module>
